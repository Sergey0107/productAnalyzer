import json


def get_tz_analyze_prompt():
    return ('Данные, которые ты получил - это данные из docx документа технического задания на покупку изделия. '
            'Извлеки характеристики и требования из документа.\n\n'
            'ВАЖНО - ОБЪЕДИНЕНИЕ ДУБЛЕЙ:\n'
            '- Если одно изделие встречается в таблице несколько раз (например, "Гидрант пожарный ГП-500" дважды) - ОБЪЕДИНИ их в ОДНУ позицию\n'
            '- При объединении СОВМЕЩАЙ все характеристики из всех вхождений\n'
            '- Не создавай дублирующиеся записи для одного наименования\n'
            '- Количество (Кол-во) бери из ПЕРВОГО вхождения\n\n'
            'ПРАВИЛА ИЗВЛЕЧЕНИЯ:\n'
            '- НЕ добавляй заголовки документа как характеристики (например: "ТЕХНИЧЕСКОЕ ЗАДАНИЕ на", "Технические характеристики")\n'
             '- НИКОГДА не придумывай данные, бери только то, что удалось распознать\n'
            '- Используй названия характеристик из документа\n'
            '- Все значения извлекай без искажения\n'
            '- Поле с null создавай ТОЛЬКО если в таблице явно пустое значение\n'
            '- Создавай отдельные поля для каждой характеристики (не объединяй в одну строку)\n'
            '- Сохраняй структуру данных из документа\n\n'
            'ФОРМАТ ОТВЕТА:\n'
            '{\n'
            '  "items": [\n'
            '    {\n'
            '      "Наименование": "название изделия",\n'
            '      "Ед. изм.": "единица",\n'
            '      "Кол-во": "количество",\n'
            '      "Характеристики": {\n'
            '        "Функциональное назначение": "значение",\n'
            '        "Подача": "значение с единицами измерения",\n'
            '        "Напор": "значение с единицами измерения",\n'
            '        "Давление на входе": "значение",\n'
            '        "Тип насоса": "значение",\n'
            '        "Перекачиваемая среда": {\n'
            '          "Наименование": "значение",\n'
            '          "Химическая формула": "значение",\n'
            '          "Температура": "значение",\n'
            '          "Плотность": "значение"\n'
            '        },\n'
            '        "Уплотнение вала": "значение",\n'
            '        "Режим работы": "значение"\n'
            '      }\n'
            '    }\n'
            '  ]\n'
            '}\n\n'
            'ВАЖНО: Создавай структурированный объект "Характеристики" с отдельными полями для каждого параметра.\n'
            'Группируй связанные характеристики во вложенные объекты (например, все параметры перекачиваемой среды в один объект).\n\n'
            'Верни данные строго в формате JSON. Только валидный JSON без текста, пояснений, markdown.')


def get_passport_initial_analyze_prompt():
    return ("Проанализируй изображения страниц технического паспорта изделия. "
            "Извлеки ТОЛЬКО технические характеристики, которые можешь распознать в документе.\n\n"
            "ВАЖНО:\n"
            "- Документ может быть размытым или низкого качества - постарайся извлечь максимум информации, но НЕ ВЫДУМЫВАЙ ЛИШНЕГО\n"
            "- Внимательно смотри на таблицы, списки, технические характеристики\n"
            "- Извлекай названия характеристик и их значения\n"
            '- НИКОГДА не придумывай данные, бери только то, что удалось распознать\n'
            "- Если текст нечеткий, но ты можешь разобрать характеристику - добавь её\n"
            "- Обращай внимание на:\n"
            "  * Основные технические данные (размеры, давление, температура, материалы)\n"
            "  * Наименование изделия\n"
            "  * Номера стандартов (ГОСТ, ТУ)\n"
            "  * Единицы измерения\n"
            "- Сохраняй единицы измерения точно как в документе\n"
            "- НЕ придумывай данные, которых нет в документе, не переименовывай названия характеристик\n"
            "- Если совсем ничего не видно на странице - верни пустой объект {}\n\n"
            "ВАЖНО - ОБРАБОТКА СЕРИЙ ИЗДЕЛИЙ:\n"
            "- Если в документе описана СЕРИЯ изделий (например: АИР 56А2, АИР 56В2, АИР 63А2 и т.д.):\n"
            "  * Верни структуру с полем \"is_series\": true\n"
            "  * Общие характеристики серии помести в \"common_characteristics\"\n"
            "  * Список моделей помести в \"models\" как массив строк\n"
            "  * Если есть индивидуальные характеристики каждой модели - добавь их в \"model_specific_characteristics\"\n"
            "- Если в документе описано ОДНО конкретное изделие:\n"
            "  * Верни структуру с полем \"is_series\": false\n"
            "  * Все характеристики помести напрямую в корневой объект\n\n"
            "ФОРМАТ ОТВЕТА ДЛЯ СЕРИИ:\n"
            "{\n"
            "  \"is_series\": true,\n"
            "  \"series_name\": \"название серии (например: Электродвигатели АИР)\",\n"
            "  \"common_characteristics\": {\n"
            "    \"характеристика1\": \"значение1\",\n"
            "    \"характеристика2\": \"значение2\"\n"
            "  },\n"
            "  \"models\": [\"модель1\", \"модель2\", \"модель3\"],\n"
            "  \"model_specific_characteristics\": {\n"
            "    \"модель1\": {\"мощность\": \"1 кВт\"},\n"
            "    \"модель2\": {\"мощность\": \"2 кВт\"}\n"
            "  }\n"
            "}\n\n"
            "ФОРМАТ ОТВЕТА ДЛЯ ОДНОГО ИЗДЕЛИЯ:\n"
            "{\n"
            "  \"is_series\": false,\n"
            "  \"характеристика1\": \"значение1\",\n"
            "  \"характеристика2\": \"значение2\"\n"
            "}\n\n"
            "- Верни данные строго в формате JSON\n"
            "- В ответе должен быть ТОЛЬКО валидный JSON, без пояснений, markdown или других текстовых блоков")


def _create_passport_iterative_prompt(accumulated_data, base_prompt):
        return (
            f"{base_prompt}\n\n"
            f"Уже извлечённые характеристики из предыдущих страниц:\n"
            f"```json\n{json.dumps(accumulated_data, ensure_ascii=False, indent=2)}\n```\n\n"
            f"Дополни этот JSON ТОЛЬКО новыми характеристиками, которые явно присутствуют на текущих страницах. "
            f"НЕ добавляй характеристики, которых нет на страницах. "
            f"Если характеристика уже есть — обнови значение только если новое более полное или точное. "
            f"Верни полный обновлённый JSON."
        )